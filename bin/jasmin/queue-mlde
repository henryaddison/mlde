#!/bin/bash
# Script for queueing a model job on LOTUS on JASMIN via lotus-wrapper script

set -euo pipefail

SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )

sgpu=1
spartition=standard
sqos=standard
saccount=furflex
smem=128G
stime=1-00:00:00

while getopts ":q:g:m:t:" opt; do
  case ${opt} in
    q)
      sqos=${OPTARG}
      ;;
    g)
      sgpu=${OPTARG}
      ;;
    m)
      smem=${OPTARG}
      ;;
    t)
      stime=${OPTARG}
      ;;
    \? )
      # echo "Invalid option: -${OPTARG}" 1>&2
     ;;
    : )
      echo "Invalid option: $OPTARG requires an argument" 1>&2
      exit 1
      ;;
  esac
done
shift "$((OPTIND -1))"


if [[ $sgpu -ge 1 ]]; then
  sqos="orchid"
fi

if [[ $sgpu -eq 0 ]] && [[ $sqos == "orchid" ]]; then
  echo "Don't use orchid when don't need a GPU"
  exit 1
fi

if [[ ${sqos} == "orchid" ]]; then
  saccount="orchid"
  spartition="orchid"
fi

sbatch --parsable --mail-type=ALL --mail-user=vf20964@bristol.ac.uk $([[ sgpu -ge 1 ]] && echo "--gres=gpu:${sgpu}") --partition=${spartition} --account=${saccount} --qos=${sqos} --time=${stime} --mem=${smem} -- ${SCRIPT_DIR}/lotus-wrapper $@
